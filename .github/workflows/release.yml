name: Release single device

on:
  push:
    branches:
      - '*'
    paths:
      - src/**
      - env.toml
  pull_request:
    types: [synchronize, opened, reopened]
    paths:
      - src/**
      - env.toml
  workflow_call:
    inputs:
      device-id:
        type: string
      magisk-preinit-device:
        type: string
        default: ''
  workflow_dispatch:
    inputs:
      device-id:
        description: Device ID
        required: true
        default: 'mustang'
      magisk-preinit-device:
        description: Magisk preinit device
        required: false
        default: 'sdb10'
      skip-rootless:
        description: Skip building rootless OTA
        type: boolean
        required: false
      skip-rooted:
        description: Skip building rooted OTA
        type: boolean
        required: false
      upload-test-ota:
        description: Upload OTA to test folder
        required: false
        type: boolean
      force-build:
        description: Force artifacts to be built and uploaded to release if non-existing
        required: false
        type: boolean
      force-ota-server-upload:
        description: Force OTA server upload
        required: false
        type: boolean
      skip-release:
        description: Skip release (build only)
        required: false
        type: boolean
      ota-version:
        description: OTA version
        required: false
      magisk-version:
        description: Magisk version
        required: false

jobs:
  build-device:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install tomlkit pydantic
          sudo apt-get update
          sudo apt-get install -y jq curl git e2fsprogs pkg-config

      - name: Set environment variables
        run: |
          DEVICE_ID=$(echo '${{ github.event.inputs.device-id || inputs.device-id || 'mustang' }}' | xargs)
          echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE_ID" >> $GITHUB_ENV

          if [[ "${{ github.event.inputs.skip-rooted }}" != "true" ]]; then
            INPUT_PREINIT=$(echo '${{ github.event.inputs.magisk-preinit-device || inputs.magisk-preinit-device }}' | xargs)
            if [[ -n "$INPUT_PREINIT" ]]; then
              echo "MAGISK_PREINIT_DEVICE=$INPUT_PREINIT" >> $GITHUB_ENV
            elif [[ "$DEVICE_ID" == "mustang" ]]; then
              echo "MAGISK_PREINIT_DEVICE=sdb10" >> $GITHUB_ENV
            else
              echo "MAGISK_PREINIT_DEVICE=sda10" >> $GITHUB_ENV
            fi
          fi

          echo "INTERACTIVE_MODE=false" >> $GITHUB_ENV
          echo "GRAPHENEOS_UPDATE_CHANNEL=stable" >> $GITHUB_ENV
          echo "SKIP_RELEASE=${{ github.event.inputs.skip-release }}" >> $GITHUB_ENV

          if [[ "${{ github.event_name }}" == "push" ]] || [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "FORCE_BUILD=true" >> $GITHUB_ENV
            echo "SKIP_RELEASE=true" >> $GITHUB_ENV
          fi

      - name: Configure Git
        run: |
          git config --global user.email "${{ secrets.EMAIL }}"
          git config --global user.name "PiX"

      - name: Decode and setup keys
        env:
          AVB_KEY: ${{ secrets.AVB_KEY }}
          OTA_KEY: ${{ secrets.OTA_KEY }}
          CERT_OTA: ${{ secrets.CERT_OTA }}
        run: |
          mkdir -p .keys

          # Decode keys directly from environment variables
          # tr -d removes any whitespace/newlines
          echo "$AVB_KEY" | tr -d '\n\r ' | base64 -d > .keys/avb.pem
          echo "$OTA_KEY" | tr -d '\n\r ' | base64 -d > .keys/ota.pem
          echo "$CERT_OTA" | tr -d '\n\r ' | base64 -d > .keys/ota.crt

          chmod 600 .keys/*.pem
          chmod 644 .keys/*.crt

          echo "Keys setup complete:"
          ls -la .keys/

          # Verify keys are valid
          if [[ -s .keys/avb.pem ]]; then
            echo "✓ AVB key created successfully"
          else
            echo "✗ AVB key is empty!"
            exit 1
          fi

          if [[ -s .keys/ota.pem ]]; then
            echo "✓ OTA key created successfully"
          else
            echo "✗ OTA key is empty!"
            exit 1
          fi

          if [[ -s .keys/ota.crt ]]; then
            echo "✓ OTA cert created successfully"
          else
            echo "✗ OTA cert is empty!"
            exit 1
          fi

      - name: Create env.toml
        env:
          PASSPHRASE_AVB: ${{ secrets.PASSPHRASE_AVB }}
          PASSPHRASE_OTA: ${{ secrets.PASSPHRASE_OTA }}
        run: |
          cat > env.toml << EOF
          [device]
          DEVICE_NAME = "${{ env.DEVICE_NAME }}"
          'GRAPHENEOS[UPDATE_CHANNEL]' = "stable"

          [avbroot]
          ARCH = "x86_64"
          AVB_KEY = ".keys/avb.pem"
          AVB_KEY_PASSPHRASE = "${PASSPHRASE_AVB}"
          OTA_KEY = ".keys/ota.pem"
          OTA_KEY_PASSPHRASE = "${PASSPHRASE_OTA}"
          CERT_OTA = ".keys/ota.crt"

          [modules]
          BCR = true
          CUSTOTA = true
          MAGISK = true
          MSD = true
          OEM_UNLOCK_ON_BOOT = true
          ALTER_INSTALLER = true
          CHARGE_LIMIT = true

          [build]
          FLAVOR = "magisk"
          INTERACTIVE_MODE = false
          CLEAN_BUILD = false
          KEEP_OUTPUT = true

          [magisk]
          PREINIT_DEVICE = "${{ env.MAGISK_PREINIT_DEVICE }}"
          EOF

          echo "env.toml created:"
          cat env.toml

      - name: Make scripts executable
        run: |
          chmod +x src/*.sh
          if [ -f setup_hooks.sh ]; then chmod +x setup_hooks.sh; fi

      - name: Build PixeneOS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          if [[ "${{ env.SKIP_RELEASE }}" == "true" ]]; then
            echo "Building without release..."
            DEBUG=1 . src/main.sh
          else
            echo "Building with release..."
            DEBUG=1 . src/util_functions.sh && create_and_make_release
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixeneos-${{ env.DEVICE_NAME }}-build
          path: |
            output/
            *.zip
            *.patched
          retention-days: 7
          if-no-files-found: ignore
