name: Release single device

on:
  workflow_dispatch:
    inputs:
      device-id:
        description: Device ID
        required: true
        default: 'mustang'
      magisk-preinit-device:
        description: Magisk preinit device
        required: false
        default: 'sdb10'
      enable-root:
        description: Enable Root (Magisk)
        required: true
        type: boolean
        default: true
      skip-release:
        description: Skip release (build only)
        required: false
        type: boolean
        default: false

jobs:
  build-device:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    permissions:
      contents: write

    env:
      KEYS_AVB_BASE64: ${{ secrets.AVB_KEY }}
      KEYS_OTA_BASE64: ${{ secrets.OTA_KEY }}
      KEYS_CERT_OTA_BASE64: ${{ secrets.CERT_OTA }}
      PASSPHRASE_AVB: ${{ secrets.PASSPHRASE_AVB }}
      PASSPHRASE_OTA: ${{ secrets.PASSPHRASE_OTA }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install tomlkit pydantic
          sudo apt-get update
          sudo apt-get install -y jq curl git e2fsprogs pkg-config

      - name: Set environment variables
        run: |
          echo "DEVICE_NAME=${{ github.event.inputs.device-id }}" >> $GITHUB_ENV
          echo "MAGISK_PREINIT_DEVICE=${{ github.event.inputs.magisk-preinit-device }}" >> $GITHUB_ENV
          echo "INTERACTIVE_MODE=false" >> $GITHUB_ENV
          echo "GRAPHENEOS_UPDATE_CHANNEL=stable" >> $GITHUB_ENV
          echo "SKIP_RELEASE=${{ github.event.inputs.skip-release }}" >> $GITHUB_ENV
          echo "ENABLE_ROOT=${{ github.event.inputs.enable-root }}" >> $GITHUB_ENV
          
          # Set flavor based on root selection
          if [[ "${{ github.event.inputs.enable-root }}" == "true" ]]; then
            echo "BUILD_FLAVOR=magisk" >> $GITHUB_ENV
          else
            echo "BUILD_FLAVOR=rootless" >> $GITHUB_ENV
          fi

      - name: Configure Git
        run: |
          git config --global user.email "${{ secrets.EMAIL }}"
          git config --global user.name "PiX"

      - name: Create env.toml
        run: |
          cat > env.toml << EOF
          [device]
          DEVICE_NAME = "${{ github.event.inputs.device-id }}"
          'GRAPHENEOS[UPDATE_CHANNEL]' = "stable"

          [avbroot]
          ARCH = "x86_64"

          [modules]
          BCR = true
          CUSTOTA = true
          MAGISK = ${{ github.event.inputs.enable-root }}
          MSD = true
          OEM_UNLOCK_ON_BOOT = true
          ALTER_INSTALLER = true
          CHARGE_LIMIT = true

          [build]
          FLAVOR = "${{ env.BUILD_FLAVOR }}"
          INTERACTIVE_MODE = false
          CLEAN_BUILD = false
          KEEP_OUTPUT = true

          [magisk]
          PREINIT_DEVICE = "${{ github.event.inputs.magisk-preinit-device }}"
          EOF

          echo "env.toml created:"
          cat env.toml

      - name: Make scripts executable
        run: |
          chmod +x src/*.sh
          [ -f setup_hooks.sh ] && chmod +x setup_hooks.sh || true

      - name: Build PixeneOS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
        run: |
          DEBUG=1 . src/main.sh

      - name: Find built files
        id: find-files
        run: |
          echo "Looking for built OTA files..."
          
          # List all files
          find . -name "*.zip" -o -name "*.patched" | head -20
          
          # Find the patched OTA
          OTA_FILE=$(find . -name "*.zip.patched" 2>/dev/null | head -1)
          
          if [[ -z "$OTA_FILE" ]]; then
            OTA_FILE=$(find ./output -name "*.zip" 2>/dev/null | head -1)
          fi
          
          if [[ -z "$OTA_FILE" ]]; then
            OTA_FILE=$(find ./.tmp -name "*patched*.zip" 2>/dev/null | head -1)
          fi
          
          echo "Found OTA: $OTA_FILE"
          echo "ota_file=$OTA_FILE" >> $GITHUB_OUTPUT
          
          # Get version
          VERSION=$(echo "$OTA_FILE" | grep -oE '[0-9]{10}' | head -1)
          if [[ -z "$VERSION" ]]; then
            VERSION=$(date +%Y%m%d%H)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create Release
        if: github.event.inputs.skip-release != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.DEVICE_NAME }}-${{ env.VERSION }}-${{ env.BUILD_FLAVOR }}
          name: PixeneOS ${{ env.DEVICE_NAME }} - ${{ env.VERSION }} (${{ env.BUILD_FLAVOR }})
          body: |
            ## PixeneOS Release
            
            **Device:** ${{ env.DEVICE_NAME }}
            **Version:** ${{ env.VERSION }}
            **Flavor:** ${{ env.BUILD_FLAVOR }}
            **Root:** ${{ github.event.inputs.enable-root }}
            
            ### Included Modules
            - BCR (Basic Call Recorder)
            - Custota (Custom OTA)
            - MSD (Mass Storage Device)
            - OEMUnlockOnBoot
            - AlterInstaller
            - ChargeLimit
            ${{ github.event.inputs.enable-root == 'true' && '- Magisk (Root)' || '' }}
            
            ### Installation
            See the [README](https://github.com/${{ github.repository }}) for installation instructions.
          files: |
            ./**/*.zip.patched
            ./**/output/*.zip
            ./**/*ota*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pixeneos-${{ env.DEVICE_NAME }}-${{ env.BUILD_FLAVOR }}-build
          path: |
            output/
            .tmp/
            *.zip
            *.patched
          retention-days: 7
          if-no-files-found: ignore
